# 爱广东短信认证问题

### 问题

均瑶云一期到二期搬迁过程中出现短信平台服务器验证问题

### 描述

登陆爱广东平台 10.10.84.8 (203.110.176.29)这台虚拟机后,使用如下命令测试与短信平台沟通

```
curl http://203.110.176.72:88/services/Sms?wsdl
```

会产生如下错误

```
Client IP /203.110.176.29 is not allowed
```

### 排查过程

经查询得知，短信供应商是鸿联九五  已经添加了29的白名单。但是我们短信服务不一样，我们自己开发了一套短信平台在上海康桥机房，然后再对接鸿联九五。我们各个子公司对接上海康桥机房的短信平台。

于是，还需要分析上海康桥机房和均瑶云二期上的爱广东平台的通信情况。

### 解决过程

爱广东平台10.10.84.8发出的短信请求需要通过上海康桥机房短信平台，所以需要短信平台开启白名单。

上海康桥机房为2个nginx做keepalived，后段2个tomcat的架构

```
nginx1	10.0.1.7 88		挂载tomcat1	10.0.1.3 8088
nginx2	10.0.1.8 88		挂载tomcat2	10.0.1.4 8088
```

nginx无需设置白名单，后端的tomcat的webapps目录下需要设置白名单

在10.0.1.3和10.0.1.4上的tomcat白名单的路径为

```
/opt/tomcat-instances/public-services/webapps/ROOT/WEB-INF/classes/available-clients.Prod.properties
```

设置完成之后，重启tomcat即可

### 添加白名单

所需添加白名单的ip地址为

```
 203.110.176.29,203.110.176.30,10.10.84.8,172.16.0.1,172.160.0.1
```

203.110.176.29,203.110.176.30为爱广东应用迁移到均瑶云二期的新公网IP地址，10.10.84.8为爱广东Radius认证服务器私有IP地址，172.16.0.1，172.160.0.1为均瑶云二期新公网IP的接口地址。